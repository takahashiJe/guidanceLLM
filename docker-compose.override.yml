# docker-compose.override.yml

services:
  api_gateway:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app/backend
    # command: >
    #   uvicorn api_gateway.app.main:app
    #   --host 0.0.0.0 --port 8000
    #   --reload --reload-dir /app/backend
    command: >
      python -m uvicorn api_gateway.app.main:app
      --host 0.0.0.0
      --port 8000
      --no-server-header
      --log-level debug
    environment:
      PYTHONUNBUFFERED: "1"   # ログをバッファせず即時出す

  worker:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    volumes:
      - ./backend:/app/backend
    command: >
      watchfiles "celery -A shared.app.celery_app.celery_app worker --loglevel=info --pool=threads --concurrency=1" /app/backend
    # ※ GPU は base compose 側の設定（gpus: all）が効いています

  frontend:
    build:
      context: ./frontend
    volumes:
      - ./frontend/streamlit_app:/app
